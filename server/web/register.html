<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>PassKey Demo</title>
    <link rel="stylesheet" type="text/css" href="/static/style.css" />
    <script src="/static/common.js"></script>
    <script src="https://unpkg.com/@simplewebauthn/browser/dist/bundle/index.umd.min.js"></script>
  </head>
  <body>
    <div class="header">
      <h1>Passkey Demo</h1>
    </div>
    <div id="notification"></div>
    <input type="text" name="username" id="username" placeholder="Username" />
    <button onclick="registerUser()">Register</button>
    <a href="/login">Already have an account?</a>
  </body>
  <script>
    // register a new user
    async function registerUser() {
      const username = document.getElementById("username").value;
      if (!username) {
        showNotification("Please enter your username");
        return;
      }

      const { startRegistration } = SimpleWebAuthnBrowser;

      const response = await fetch(`/register/begin/${username}`);
      let attestationResponse;
      try {
        const credentialCreationOptions = await response.json();
        attestationResponse = await startRegistration({
          optionsJSON: credentialCreationOptions.publicKey,
        });
      } catch (err) {
        if (err.name === "InvalidStateError") {
          showNotification("User already exists");
        } else {
          showNotification("Registration canceled or Failed due to an error.");
        }
        return;
      }

      const verificationResponse = await fetch(`/register/finish/${username}`, {
        method: "POST",
        body: JSON.stringify(attestationResponse),
        headers: {
          "Content-Type": "application/json",
        },
      });

      const verificationResponseJSON = await verificationResponse.json();

      if (
        verificationResponseJSON &&
        verificationResponseJSON.status === "ok"
      ) {
        showNotification("Successfully registered.");
      } else {
        showNotification("Registration failed.");
      }
    }
  </script>
</html>
