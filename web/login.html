<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Passkey Demo</title>
    <link rel="stylesheet" href="/static/style.css" />
    <script src="/static/common.js"></script>
    <script src="https://unpkg.com/@simplewebauthn/browser/dist/bundle/index.umd.min.js"></script>
  </head>
  <body>
    <div class="header">
      <h1>Passkey Demo</h1>
    </div>
    <div id="notification"></div>
    <input
      type="text"
      id="username"
      name="username"
      placeholder="Enter username"
    />
    <button onclick="loginUser()">Login</button>
    <a class="link" href="/">Don't have an account?</a>
  </body>
  <script>
    // login a user
    async function loginUser() {
      const username = document.getElementById("username").value;
      if (!username) {
        showNotification("Please enter your username");
        return;
      }

      const { startAuthentication } = SimpleWebAuthnBrowser;

      const response = await fetch(`/login/begin/${username}`);
      let assertionResponse;

      try {
        const credentialRequestOptions = await response.json();
        assertionResponse = await startAuthentication({
          optionsJSON: credentialRequestOptions.publicKey,
        });
      } catch (err) {
        throw err;
      }

      const verificationResponse = await fetch(`/login/finish/${username}`, {
        method: "POST",
        body: JSON.stringify(assertionResponse),
        headers: {
          "Content-Type": "application/json",
        },
      });

      const verificationResponseJSON = await verificationResponse.json();

      if (
        verificationResponseJSON &&
        verificationResponseJSON.status === "ok"
      ) {
        showNotification("Successfully logged in.");
      } else {
        showNotification("Login failed.");
      }
    }
  </script>
</html>
