<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Passkey Demo</title>
    <link rel="stylesheet" href="/static/style.css" />
    <script src="/static/common.js"></script>
  </head>
  <body>
    <div class="header">
      <h1>Passkey Demo</h1>
    </div>
    <div id="notification"></div>
    <input
      type="text"
      id="username"
      name="username"
      placeholder="Enter username"
    />
    <button onclick="loginUser()">Login</button>
    <a class="link" href="/">Don't have an account?</a>
  </body>
  <script>
    // login a user
    function loginUser() {
      const username = document.getElementById("username").value;
      if (!username) {
        showNotification("Please enter your username");
        return;
      }

      fetch(`/login/begin/${username}`)
        .then((res) => res.json())
        .then((credentialRequestOptions) => {
          credentialRequestOptions.publicKey.challenge = bufferDecode(
            credentialRequestOptions.publicKey.challenge
          );

          credentialRequestOptions.publicKey.allowCredentials.forEach(
            (credential) => {
              credential.id = bufferDecode(credential.id);
            }
          );

          return navigator.credentials.get({
            publicKey: credentialRequestOptions.publicKey,
          });
        })
        .then((assertion) => {
          console.log("success fetching navigator.credentials.get()");
          let authData = assertion.response.authenticatorData;
          let clientDataJSON = assertion.response.clientDataJSON;
          let rawId = assertion.rawId;
          let sig = assertion.response.signature;
          let userHandle = assertion.response.userHandle;

          fetch(`/login/finish/${username}`, {
            method: "POST",
            body: JSON.stringify({
              id: assertion.id,
              rawID: bufferEncode(rawId),
              type: assertion.type,
              response: {
                authenticatorData: bufferEncode(authData),
                clientDataJSON: bufferEncode(clientDataJSON),
                signature: bufferEncode(sig),
                userHandle: bufferEncode(userHandle),
              },
            }),
            headers: {
              "Content-Type": "application/json",
            },
          });
        })
        .then(() => {
          console.log("sign in with passkey successful");
          showNotification("Successfully logged in.");
        })
        .catch((err) => {
          console.error("Error:", err);
          showNotification("Login failed.");
        });
    }
  </script>
</html>
